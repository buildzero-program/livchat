{
  "master": {
    "tasks": [
      {
        "id": "12",
        "title": "Rename demo router to whatsapp router",
        "description": "Rename the demo.ts router file to whatsapp.ts and update all internal references from demoRouter to whatsappRouter for naming consistency",
        "details": "1. Rename file src/server/api/routers/demo.ts to src/server/api/routers/whatsapp.ts\n2. Inside the renamed file, change:\n   - `export const demoRouter` → `export const whatsappRouter`\n   - Update any internal comments referencing 'demo'\n3. Update src/server/api/root.ts:\n   - Change import: `import { demoRouter } from \"./routers/demo\"` → `import { whatsappRouter } from \"./routers/whatsapp\"`\n   - Change router registration: `demo: demoRouter` → `whatsapp: whatsappRouter`\n4. Ensure all exports maintain the same procedure names (status, pairing, validate, send, disconnect)\n5. Run `bun typecheck` to verify no type errors after rename",
        "testStrategy": "1. Run `bun typecheck` to verify TypeScript compilation succeeds\n2. Run `bun build` to verify Next.js build succeeds\n3. Verify the tRPC router is accessible via api.whatsapp.* namespace\n4. Manually test the LP (landing page) to ensure QR code and pairing still work",
        "priority": "high",
        "dependencies": [],
        "status": "done",
        "subtasks": [],
        "complexity": 2,
        "recommendedSubtasks": 0,
        "expansionPrompt": "Simple file rename and find-replace task. Rename demo.ts to whatsapp.ts, update exports from demoRouter to whatsappRouter, and update root.ts import.",
        "updatedAt": "2025-12-07T15:52:42.259Z"
      },
      {
        "id": "13",
        "title": "Rename useDemo hook to useWhatsApp hook",
        "description": "Rename the useDemo hook to useWhatsApp and update all internal API calls from api.demo.* to api.whatsapp.*",
        "details": "1. Rename file src/hooks/useDemo.ts to src/hooks/useWhatsApp.ts\n2. Inside the renamed file:\n   - Change function name: `export function useDemo()` → `export function useWhatsApp()`\n   - Change type: `UseDemoReturn` → `UseWhatsAppReturn`\n   - Update all tRPC calls: `api.demo.status` → `api.whatsapp.status`, `api.demo.pairing` → `api.whatsapp.pairing`, etc.\n   - Update import type: `import type { ValidationResult } from \"~/server/api/routers/demo\"` → `import type { ValidationResult } from \"~/server/api/routers/whatsapp\"`\n   - Update localStorage key from `livchat_demo_state` to `livchat_whatsapp_state` (optional, for clarity)\n3. Update all consumers:\n   - src/components/marketing/hero.tsx: Change `import { useDemo } from \"~/hooks/useDemo\"` → `import { useWhatsApp } from \"~/hooks/useWhatsApp\"` and `const demo = useDemo()` → `const whatsapp = useWhatsApp()` (or keep variable name as `demo` for minimal changes)",
        "testStrategy": "1. Run `bun typecheck` to verify all imports resolve correctly\n2. Run `bun build` to verify Next.js build succeeds\n3. Manually test the LP (landing page) to ensure:\n   - QR code displays correctly\n   - Pairing code generation works\n   - Send message functionality works\n   - Disconnect functionality works",
        "priority": "high",
        "dependencies": [
          "12"
        ],
        "status": "done",
        "subtasks": [],
        "complexity": 2,
        "recommendedSubtasks": 0,
        "expansionPrompt": "Rename useDemo.ts to useWhatsApp.ts, update function/type names, change all api.demo.* to api.whatsapp.*, and update consumer in hero.tsx.",
        "updatedAt": "2025-12-07T16:06:51.476Z"
      },
      {
        "id": "14",
        "title": "Rename demo.test.ts to whatsapp.test.ts",
        "description": "Rename the test file and update all internal references to match the new whatsapp router naming",
        "details": "1. Rename file tests/unit/server/api/routers/demo.test.ts → whatsapp.test.ts\n2. Update imports:\n   - `import { demoRouter } from \"~/server/api/routers/demo\"` → `import { whatsappRouter } from \"~/server/api/routers/whatsapp\"`\n3. Update describe block: `describe(\"Demo Router\"` → `describe(\"WhatsApp Router\"`\n4. Update all nested describe blocks: `describe(\"demo.status\"` → `describe(\"whatsapp.status\"`, etc.\n5. Update caller factory: `createCallerFactory(demoRouter as any)` → `createCallerFactory(whatsappRouter as any)`\n6. Run all tests to ensure they pass with the new naming",
        "testStrategy": "1. Run `bun test tests/unit/server/api/routers/whatsapp.test.ts` to verify all tests pass\n2. Run `bun test` to ensure full test suite passes\n3. Verify test coverage is maintained",
        "priority": "high",
        "dependencies": [
          "12"
        ],
        "status": "done",
        "subtasks": [],
        "complexity": 2,
        "recommendedSubtasks": 0,
        "expansionPrompt": "Rename test file, update import to whatsappRouter, update describe blocks and caller factory reference.",
        "updatedAt": "2025-12-07T16:06:54.213Z"
      },
      {
        "id": "15",
        "title": "Add whatsapp.list procedure for dashboard",
        "description": "Create a new protectedProcedure in the whatsapp router to list all instances belonging to the authenticated user's organization",
        "details": "1. In src/server/api/routers/whatsapp.ts, import protectedProcedure from trpc.ts\n2. Add new procedure `list` using protectedProcedure:\n```typescript\nlist: protectedProcedure.query(async ({ ctx }) => {\n  const { user, log } = ctx;\n  \n  // Import getOrganizationInstances from instance.ts\n  const instances = await getOrganizationInstances(user.organizationId);\n  \n  if (instances.length === 0) {\n    return { instances: [], total: 0, maxInstances: 1 };\n  }\n  \n  // For each instance, fetch current status from WuzAPI\n  const instancesWithStatus = await Promise.all(\n    instances.map(async (instance) => {\n      const client = new WuzAPIClient({\n        baseUrl: WUZAPI_BASE_URL,\n        token: instance.providerToken,\n      });\n      \n      try {\n        const status = await client.getStatus();\n        return {\n          id: instance.id,\n          name: instance.name,\n          phoneNumber: extractPhoneFromJID(instance.whatsappJid),\n          deviceName: instance.whatsappName ?? \"WhatsApp Web\",\n          pictureUrl: instance.whatsappPictureUrl,\n          connected: status.data.connected,\n          loggedIn: status.data.loggedIn,\n          connectedSince: instance.lastConnectedAt?.toISOString() ?? null,\n          messagesUsed: instance.messagesUsedToday,\n        };\n      } catch {\n        return { ...offlineDefaults };\n      }\n    })\n  );\n  \n  // Fetch org for limits\n  const org = await db.query.organizations.findFirst({\n    where: eq(organizations.ownerId, user.id),\n  });\n  \n  return {\n    instances: instancesWithStatus,\n    total: instances.length,\n    maxInstances: org?.maxInstances ?? 1,\n    messagesLimit: org?.maxMessagesPerDay ?? 50,\n  };\n}),\n```\n3. Add necessary imports: organizations from schema, eq from drizzle-orm",
        "testStrategy": "1. Create unit test in whatsapp.test.ts for whatsapp.list:\n   - Test returns empty array when org has no instances\n   - Test returns instances with status when org has instances\n   - Test handles WuzAPI errors gracefully (returns offline status)\n2. Integration test: Login to dashboard and verify API returns correct data\n3. Test with mock authenticated user context",
        "priority": "high",
        "dependencies": [
          "12",
          "13",
          "14"
        ],
        "status": "done",
        "subtasks": [],
        "complexity": 5,
        "recommendedSubtasks": 4,
        "expansionPrompt": "Implement the list procedure: (1) Create protectedProcedure that fetches organization instances using existing getOrganizationInstances helper, (2) For each instance, call WuzAPIClient.getStatus() to get real-time connection status, (3) Fetch organization limits from database, (4) Return formatted response with instances array including id, phoneNumber, deviceName, pictureUrl, connected, loggedIn, connectedSince, messagesUsed, plus total/maxInstances/messagesLimit. Handle WuzAPI errors gracefully by returning offline status. Write unit tests for empty state, populated state, and error handling.",
        "updatedAt": "2025-12-07T16:41:09.973Z"
      },
      {
        "id": "16",
        "title": "Add connectedSince, deviceName, and pictureUrl to whatsapp.status",
        "description": "Extend the whatsapp.status response to include additional fields needed by the InstancesWidget",
        "details": "1. In src/server/api/routers/whatsapp.ts, locate the `status` procedure\n2. Modify the response object to include new fields:\n```typescript\nconst response = {\n  // Existing fields\n  connected: statusRes.data.connected,\n  loggedIn: statusRes.data.loggedIn,\n  qrCode,\n  jid: extractPhoneFromJID(statusRes.data.jid),\n  instanceId: instance.id,\n  apiKey: statusRes.data.loggedIn ? instance.providerToken : undefined,\n  messagesUsed: usage.used,\n  messagesLimit: usage.limit,\n  messagesRemaining: usage.remaining,\n  \n  // NEW FIELDS for InstancesWidget\n  connectedSince: instance.lastConnectedAt?.toISOString() ?? null,\n  deviceName: instance.whatsappName ?? statusRes.data.name ?? \"WhatsApp Web\",\n  pictureUrl: instance.whatsappPictureUrl ?? null,\n};\n```\n3. Update the error fallback response to include these fields with null/default values\n4. Update the useWhatsApp hook to expose these new fields in the return type",
        "testStrategy": "1. Update existing unit tests to verify new fields are present in response\n2. Test that connectedSince returns null when instance never connected\n3. Test that deviceName falls back to \"WhatsApp Web\" when not set\n4. Test that pictureUrl returns null when not set\n5. Verify hook exposes new fields correctly",
        "priority": "medium",
        "dependencies": [
          "15"
        ],
        "status": "done",
        "subtasks": [],
        "complexity": 2,
        "recommendedSubtasks": 0,
        "expansionPrompt": "Add three new fields to the status procedure response: connectedSince from instance.lastConnectedAt, deviceName from instance.whatsappName with fallback, pictureUrl from instance.whatsappPictureUrl. Update useWhatsApp hook to expose these fields.",
        "updatedAt": "2025-12-07T16:41:13.241Z"
      },
      {
        "id": "17",
        "title": "Install @vercel/blob and create blob-storage helper",
        "description": "Install the @vercel/blob package and create a helper module for uploading and managing profile pictures",
        "details": "1. Install @vercel/blob: `bun add @vercel/blob`\n2. Create new file src/server/lib/blob-storage.ts:\n```typescript\nimport { put, del } from \"@vercel/blob\";\n\n/**\n * Upload profile picture to Vercel Blob\n * @param imageUrl - Source URL of the image (from WhatsApp)\n * @param instanceId - Instance UUID for unique naming\n * @returns Blob URL of the uploaded image\n */\nexport async function uploadProfilePicture(\n  imageUrl: string,\n  instanceId: string\n): Promise<string> {\n  // Fetch image from WhatsApp\n  const response = await fetch(imageUrl);\n  if (!response.ok) {\n    throw new Error(`Failed to fetch image: ${response.status}`);\n  }\n  \n  const blob = await response.blob();\n  \n  // Upload to Vercel Blob with unique path\n  const { url } = await put(\n    `avatars/${instanceId}.jpg`,\n    blob,\n    { access: \"public\" }\n  );\n  \n  return url;\n}\n\n/**\n * Delete profile picture from Vercel Blob\n */\nexport async function deleteProfilePicture(instanceId: string): Promise<void> {\n  try {\n    await del(`avatars/${instanceId}.jpg`);\n  } catch {\n    // Ignore if file doesn't exist\n  }\n}\n```\n3. Verify BLOB_READ_WRITE_TOKEN is set in .env (already exists per PRD)",
        "testStrategy": "1. Unit test uploadProfilePicture with mocked fetch and @vercel/blob\n2. Test error handling when source image URL is invalid\n3. Test deleteProfilePicture doesn't throw when file doesn't exist\n4. Integration test: Upload a test image and verify URL is accessible",
        "priority": "medium",
        "dependencies": [],
        "status": "done",
        "subtasks": [],
        "complexity": 3,
        "recommendedSubtasks": 0,
        "expansionPrompt": "Install @vercel/blob package, create src/server/lib/blob-storage.ts with uploadProfilePicture (fetch from URL, upload to Vercel Blob) and deleteProfilePicture functions. Handle errors gracefully.",
        "updatedAt": "2025-12-07T16:05:39.238Z"
      },
      {
        "id": "18",
        "title": "Add getAvatar method to WuzAPIClient",
        "description": "Extend the WuzAPIClient class to support fetching WhatsApp profile pictures",
        "details": "1. In src/server/lib/wuzapi.ts, add new interface for avatar response:\n```typescript\nexport interface WuzAPIAvatarData {\n  URL?: string;\n  ID?: string;\n}\n```\n2. Add getAvatar method to WuzAPIClient class:\n```typescript\n/**\n * GET /user/avatar\n * Fetches the profile picture URL for a WhatsApp number\n */\nasync getAvatar(jid: string): Promise<WuzAPIResponse<WuzAPIAvatarData>> {\n  const phone = jid.replace(\"@s.whatsapp.net\", \"\");\n  return this.request<WuzAPIAvatarData>(`/user/avatar?Phone=${phone}&Preview=false`, {\n    method: \"GET\",\n  });\n}\n```\n3. Note: The WuzAPI /user/avatar endpoint requires the phone number without @domain",
        "testStrategy": "1. Unit test getAvatar returns URL when avatar exists\n2. Unit test getAvatar returns empty URL when user has no avatar\n3. Test phone number extraction from JID format\n4. Mock WuzAPI response in tests",
        "priority": "medium",
        "dependencies": [],
        "status": "done",
        "subtasks": [],
        "complexity": 2,
        "recommendedSubtasks": 0,
        "expansionPrompt": "Add WuzAPIAvatarData interface and getAvatar method to WuzAPIClient class in wuzapi.ts. Method should extract phone from JID and call /user/avatar endpoint.",
        "updatedAt": "2025-12-07T16:03:22.925Z"
      },
      {
        "id": "19",
        "title": "Add whatsapp.updateAvatar procedure",
        "description": "Create a new protectedProcedure to fetch WhatsApp profile picture and store it in Vercel Blob",
        "details": "1. In src/server/api/routers/whatsapp.ts, add new mutation:\n```typescript\nimport { uploadProfilePicture } from \"~/server/lib/blob-storage\";\nimport { getInstanceWithAccess } from \"~/server/lib/instance\";\n\nupdateAvatar: protectedProcedure\n  .input(z.object({ instanceId: z.string().uuid() }))\n  .mutation(async ({ ctx, input }) => {\n    const { user, log } = ctx;\n    \n    // Get instance with access check\n    const instanceData = await getInstanceWithAccess(input.instanceId, {\n      organizationId: user.organizationId,\n    });\n    \n    if (!instanceData) {\n      throw new TRPCError({ code: \"NOT_FOUND\", message: \"Instance not found\" });\n    }\n    \n    const { instance, client } = instanceData;\n    \n    if (!instance.whatsappJid) {\n      throw new TRPCError({ code: \"PRECONDITION_FAILED\", message: \"Instance not connected\" });\n    }\n    \n    try {\n      // Fetch avatar from WhatsApp\n      const avatarRes = await client.getAvatar(instance.whatsappJid);\n      \n      if (!avatarRes.data.URL) {\n        return { success: false, pictureUrl: null };\n      }\n      \n      // Upload to Vercel Blob\n      const blobUrl = await uploadProfilePicture(\n        avatarRes.data.URL,\n        instance.id\n      );\n      \n      // Save URL to database\n      await db\n        .update(instances)\n        .set({ \n          whatsappPictureUrl: blobUrl,\n          updatedAt: new Date(),\n        })\n        .where(eq(instances.id, instance.id));\n      \n      return { success: true, pictureUrl: blobUrl };\n    } catch (error) {\n      log.error(LogActions.WUZAPI_AVATAR, \"Failed to update avatar\", error);\n      return { success: false, pictureUrl: null };\n    }\n  }),\n```\n2. Add LogActions.WUZAPI_AVATAR to logger.ts if not exists",
        "testStrategy": "1. Unit test successful avatar update flow\n2. Test access control - user can only update their org's instances\n3. Test graceful handling when WhatsApp user has no avatar\n4. Test error handling when Blob upload fails\n5. Verify database is updated with new URL",
        "priority": "medium",
        "dependencies": [
          "15",
          "17",
          "18"
        ],
        "status": "in-progress",
        "subtasks": [],
        "complexity": 4,
        "recommendedSubtasks": 0,
        "expansionPrompt": "Create protectedProcedure mutation that: validates instanceId input, gets instance with access check using getInstanceWithAccess, calls client.getAvatar to fetch WhatsApp avatar URL, uploads to Vercel Blob via uploadProfilePicture, saves URL to database. Handle cases: instance not found, not connected, no avatar, upload failure.",
        "updatedAt": "2025-12-07T17:27:01.178Z"
      },
      {
        "id": "20",
        "title": "Create InstancesWidget component with carousel",
        "description": "Build the InstancesWidget React component with carousel navigation for multiple instances, real data from tRPC, and proper loading/error/empty states",
        "details": "1. Create new file src/components/dashboard/instances-widget.tsx:\n```typescript\n\"use client\";\n\nimport { useState } from \"react\";\nimport { api } from \"~/trpc/react\";\nimport { ChevronLeft, ChevronRight, Smartphone, RefreshCw, Power, Wifi, WifiOff, Clock } from \"lucide-react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"~/components/ui/card\";\nimport { Button } from \"~/components/ui/button\";\nimport { Badge } from \"~/components/ui/badge\";\nimport { Avatar, AvatarImage, AvatarFallback } from \"~/components/ui/avatar\";\nimport { Skeleton } from \"~/components/ui/skeleton\";\nimport { motion } from \"framer-motion\";\nimport { formatRelativeTime } from \"~/lib/mock-dashboard\";\n\nexport function InstancesWidget() {\n  const [currentIndex, setCurrentIndex] = useState(0);\n  \n  const { data, isLoading, error, refetch } = api.whatsapp.list.useQuery(undefined, {\n    refetchInterval: 30000, // Poll every 30s\n  });\n  \n  const disconnectMutation = api.whatsapp.disconnect.useMutation({\n    onSuccess: () => refetch(),\n  });\n  \n  if (isLoading) return <InstancesWidgetSkeleton />;\n  if (error) return <InstancesWidgetError error={error.message} />;\n  if (!data?.instances.length) return <InstancesWidgetEmpty />;\n  \n  const instance = data.instances[currentIndex];\n  const total = data.instances.length;\n  const isOnline = instance?.loggedIn;\n  \n  const goNext = () => setCurrentIndex((i) => (i + 1) % total);\n  const goPrev = () => setCurrentIndex((i) => (i - 1 + total) % total);\n  \n  // Helper to get initials from phone number\n  const getInitials = (phone: string | null) => {\n    if (!phone) return \"WA\";\n    return phone.slice(-2);\n  };\n  \n  return (\n    <Card className=\"relative overflow-hidden\">\n      {/* Glow effect when online */}\n      {isOnline && (\n        <div className=\"absolute inset-0 bg-gradient-to-br from-green-500/5 to-transparent pointer-events-none\" />\n      )}\n      \n      <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n        <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n          <Smartphone className=\"h-4 w-4\" />\n          Conexão WhatsApp\n        </CardTitle>\n        \n        {/* Navigation badge for multiple instances */}\n        {total > 1 && (\n          <div className=\"flex items-center gap-1\">\n            <Button variant=\"ghost\" size=\"icon\" className=\"h-6 w-6\" onClick={goPrev}>\n              <ChevronLeft className=\"h-4 w-4\" />\n            </Button>\n            <Badge variant=\"secondary\" className=\"text-xs\">\n              {currentIndex + 1}/{total}\n            </Badge>\n            <Button variant=\"ghost\" size=\"icon\" className=\"h-6 w-6\" onClick={goNext}>\n              <ChevronRight className=\"h-4 w-4\" />\n            </Button>\n          </div>\n        )}\n      </CardHeader>\n      \n      <CardContent className=\"space-y-4\">\n        {/* Avatar and phone info */}\n        <div className=\"flex items-center gap-4\">\n          <Avatar className=\"h-16 w-16\">\n            {instance.pictureUrl ? (\n              <AvatarImage src={instance.pictureUrl} alt={instance.phoneNumber ?? \"\"} />\n            ) : (\n              <AvatarFallback className=\"text-lg\">\n                {getInitials(instance.phoneNumber)}\n              </AvatarFallback>\n            )}\n          </Avatar>\n          <div>\n            <p className=\"text-2xl font-bold tracking-tight\">\n              {instance.phoneNumber ? formatPhoneDisplay(instance.phoneNumber) : \"Não conectado\"}\n            </p>\n            <p className=\"text-xs text-muted-foreground\">\n              {instance.deviceName}\n            </p>\n          </div>\n        </div>\n        \n        {/* Status badge and uptime */}\n        <div className=\"flex items-center gap-4 text-sm text-muted-foreground\">\n          <Badge variant={isOnline ? \"default\" : \"destructive\"} className={isOnline ? \"bg-green-500/10 text-green-500 border-green-500/20\" : \"\"}>\n            <motion.span\n              className={`w-2 h-2 rounded-full mr-1.5 ${isOnline ? \"bg-green-500\" : \"bg-red-500\"}`}\n              animate={isOnline ? { scale: [1, 1.2, 1] } : {}}\n              transition={{ duration: 2, repeat: Infinity }}\n            />\n            {isOnline ? \"Online\" : \"Offline\"}\n          </Badge>\n          {instance.connectedSince && (\n            <div className=\"flex items-center gap-1.5\">\n              <Clock className=\"h-3.5 w-3.5\" />\n              <span>{formatRelativeTime(new Date(instance.connectedSince))}</span>\n            </div>\n          )}\n        </div>\n        \n        {/* Action buttons */}\n        <div className=\"flex gap-2 pt-2\">\n          <Button variant=\"outline\" size=\"sm\" className=\"flex-1\" onClick={() => refetch()}>\n            <RefreshCw className=\"h-3.5 w-3.5 mr-1.5\" />\n            Reconectar\n          </Button>\n          <Button\n            variant=\"outline\"\n            size=\"sm\"\n            className=\"text-red-500 hover:text-red-600 hover:bg-red-500/10\"\n            onClick={() => disconnectMutation.mutate()}\n            disabled={disconnectMutation.isPending}\n          >\n            <Power className=\"h-3.5 w-3.5\" />\n          </Button>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n\n// Helper to format phone for display\nfunction formatPhoneDisplay(phone: string): string {\n  if (phone.startsWith(\"55\") && phone.length === 13) {\n    return `+${phone.slice(0, 2)} ${phone.slice(2, 4)} ${phone.slice(4, 9)}-${phone.slice(9)}`;\n  }\n  return `+${phone}`;\n}\n\n// Skeleton loading state\nfunction InstancesWidgetSkeleton() { ... }\n\n// Empty state\nfunction InstancesWidgetEmpty() { ... }\n\n// Error state  \nfunction InstancesWidgetError({ error }: { error: string }) { ... }\n```\n2. Implement skeleton, empty, and error states as shown in PRD section 4.2",
        "testStrategy": "1. Unit test component renders correctly with mock tRPC data\n2. Test carousel navigation increments/decrements correctly\n3. Test carousel wraps around at boundaries\n4. Test loading skeleton displays during fetch\n5. Test empty state displays when no instances\n6. Test error state displays on API error\n7. Test disconnect button calls mutation\n8. Visual test: Component matches design mockups",
        "priority": "high",
        "dependencies": [
          "15",
          "16"
        ],
        "status": "done",
        "subtasks": [
          {
            "id": 1,
            "title": "Create main InstancesWidget component with tRPC integration",
            "description": "Build the core InstancesWidget component with useState for carousel index, useQuery for api.whatsapp.list with 30s refetchInterval, and disconnect mutation setup",
            "dependencies": [],
            "details": "Create new file src/components/dashboard/instances-widget.tsx with 'use client' directive. Import useState from react, api from ~/trpc/react, and required lucide icons (ChevronLeft, ChevronRight, Smartphone, RefreshCw, Power, Wifi, WifiOff, Clock). Setup useState(0) for currentIndex. Configure useQuery for api.whatsapp.list with { refetchInterval: 30000 } for 30s polling. Setup useMutation for api.whatsapp.disconnect with onSuccess callback to refetch. Export the InstancesWidget function component with conditional rendering: loading returns skeleton, error returns error state, empty data returns empty state.",
            "status": "pending",
            "testStrategy": "Unit test that component calls api.whatsapp.list on mount. Test that disconnect mutation is properly configured with refetch callback. Mock tRPC to verify polling interval configuration.",
            "parentId": "undefined"
          },
          {
            "id": 2,
            "title": "Implement carousel navigation with wrap-around logic",
            "description": "Add carousel navigation UI with ChevronLeft/Right buttons, index badge display, and goNext/goPrev handlers with wrap-around",
            "dependencies": [
              1
            ],
            "details": "In CardHeader, add navigation controls that only render when total > 1. Create goNext function: setCurrentIndex((i) => (i + 1) % total). Create goPrev function: setCurrentIndex((i) => (i - 1 + total) % total). Render Button variant='ghost' size='icon' className='h-6 w-6' with ChevronLeft/ChevronRight icons. Display Badge variant='secondary' className='text-xs' showing '{currentIndex + 1}/{total}'. Access current instance via data.instances[currentIndex].",
            "status": "pending",
            "testStrategy": "Test goNext increments index correctly. Test goPrev decrements correctly. Test wrap-around: goNext at last index goes to 0, goPrev at 0 goes to last. Test navigation UI only renders when total > 1.",
            "parentId": "undefined"
          },
          {
            "id": 3,
            "title": "Build instance card UI with avatar, status, and action buttons",
            "description": "Create the instance display card with Avatar component, phone number formatting, device name, animated status badge, uptime display, and Reconnect/Disconnect action buttons",
            "dependencies": [
              1
            ],
            "details": "Import Card, CardContent, CardHeader, CardTitle, Button, Badge, Avatar, AvatarImage, AvatarFallback from ~/components/ui/*. Import motion from framer-motion and formatRelativeTime from ~/lib/mock-dashboard. Create formatPhoneDisplay helper for Brazilian phone formatting. Create getInitials helper returning last 2 digits or 'WA' fallback. Render Avatar h-16 w-16 with AvatarImage for pictureUrl or AvatarFallback with initials. Display phone number formatted with text-2xl font-bold, device name as text-xs text-muted-foreground. Create animated status Badge with motion.span pulsing circle (scale [1, 1.2, 1] duration 2s repeat Infinity) when online. Show uptime with Clock icon using formatRelativeTime. Add glow effect div when online (bg-gradient-to-br from-green-500/5). Create action buttons: Reconnect (calls refetch), Disconnect (calls disconnectMutation.mutate with isPending disabled state).",
            "status": "pending",
            "testStrategy": "Test Avatar renders correctly with pictureUrl when available. Test fallback initials display. Test phone number formatting for Brazilian numbers. Test status badge shows Online/Offline correctly. Test animated pulse only runs when online. Test Disconnect button disabled state during mutation.",
            "parentId": "undefined"
          },
          {
            "id": 4,
            "title": "Create InstancesWidgetSkeleton loading state",
            "description": "Implement skeleton loading state component with animated placeholders matching the widget layout",
            "dependencies": [
              1
            ],
            "details": "Create InstancesWidgetSkeleton function component. Import Skeleton from ~/components/ui/skeleton. Wrap in Card with same structure as main widget. In CardHeader, render Skeleton h-4 w-32 for title. In CardContent, render: Skeleton h-16 w-16 rounded-full for avatar, Skeleton h-6 w-40 for phone number, Skeleton h-4 w-24 for device name, Skeleton h-5 w-16 for status badge, Skeleton h-5 w-20 for uptime. Add flex gap-2 pt-2 with two button Skeletons (h-9 flex-1 and h-9 w-9). All Skeletons use animate-pulse via the Skeleton component's built-in animation.",
            "status": "pending",
            "testStrategy": "Test skeleton component renders without errors. Test all skeleton elements have correct dimensions matching the main widget. Verify skeleton is displayed when isLoading is true.",
            "parentId": "undefined"
          },
          {
            "id": 5,
            "title": "Create InstancesWidgetEmpty and InstancesWidgetError states",
            "description": "Implement empty state for no instances and error state for API errors with appropriate messaging and CTAs",
            "dependencies": [
              1
            ],
            "details": "Create InstancesWidgetEmpty component: Card wrapper with CardHeader showing Smartphone icon and 'Conexão WhatsApp' title. CardContent with WifiOff icon h-8 w-8 text-muted-foreground, heading 'Nenhuma instância', text 'Conecte seu WhatsApp para começar', and Button with Wifi icon 'Conectar WhatsApp' (link to connect flow). Create InstancesWidgetError component accepting { error: string } prop: Card wrapper with CardHeader showing title and destructive Badge 'Erro'. CardContent with AlertCircle icon (import from lucide-react), error message display, and Button variant='outline' with RefreshCw icon 'Tentar novamente' (can onClick reload page or retry).",
            "status": "pending",
            "testStrategy": "Test empty state renders when data.instances is empty array. Test error state renders when useQuery returns error. Test error message is displayed correctly. Test 'Conectar WhatsApp' button in empty state is clickable. Test 'Tentar novamente' button in error state works.",
            "parentId": "undefined"
          }
        ],
        "complexity": 6,
        "recommendedSubtasks": 5,
        "expansionPrompt": "Create InstancesWidget: (1) Build main component with useState for currentIndex, useQuery for api.whatsapp.list with 30s refetchInterval, (2) Implement carousel navigation with ChevronLeft/Right buttons and index display, (3) Create instance card UI with Avatar, phone number, device name, status badge with animation, uptime display, and action buttons (Reconnect, Disconnect), (4) Create InstancesWidgetSkeleton loading state with animated placeholders, (5) Create InstancesWidgetEmpty state for no instances, (6) Create InstancesWidgetError state. Wire disconnect mutation to api.whatsapp.disconnect. Use existing UI components from ~/components/ui/*.",
        "updatedAt": "2025-12-07T17:27:05.875Z"
      },
      {
        "id": "21",
        "title": "Update dashboard page to use InstancesWidget",
        "description": "Replace ConnectionWidget with InstancesWidget in the dashboard page and update the component exports",
        "details": "1. Update src/components/dashboard/index.ts:\n```typescript\nexport { InstancesWidget } from \"./instances-widget\";\nexport { ConnectionWidget } from \"./connection-widget\"; // Keep for LP if needed\nexport { MetricsWidget } from \"./metrics-widget\";\nexport { QuotaWidget } from \"./quota-widget\";\nexport { ActivityWidget } from \"./activity-widget\";\nexport { QuickTestWidget } from \"./quick-test-widget\";\n```\n2. Update src/app/(app)/app/page.tsx:\n```typescript\nimport {\n  InstancesWidget, // Changed from ConnectionWidget\n  MetricsWidget,\n  QuotaWidget,\n  ActivityWidget,\n  QuickTestWidget,\n} from \"~/components/dashboard\";\n\n// In the grid, replace:\n<motion.div variants={itemVariants}>\n  <InstancesWidget /> {/* Was ConnectionWidget */}\n</motion.div>\n```\n3. Keep ConnectionWidget file for potential LP usage or remove if not needed",
        "testStrategy": "1. Run `bun build` to verify no import errors\n2. Navigate to /app/dashboard and verify InstancesWidget renders\n3. Verify other widgets still render correctly\n4. Test responsive layout on mobile and desktop\n5. Verify animation transitions work correctly",
        "priority": "high",
        "dependencies": [
          "20"
        ],
        "status": "in-progress",
        "subtasks": [],
        "complexity": 1,
        "recommendedSubtasks": 0,
        "expansionPrompt": "Update dashboard/index.ts exports to add InstancesWidget. Update app/(app)/app/page.tsx to import and use InstancesWidget instead of ConnectionWidget.",
        "updatedAt": "2025-12-07T17:47:52.929Z"
      },
      {
        "id": "22",
        "title": "End-to-end testing and final verification",
        "description": "Perform comprehensive end-to-end testing of the complete feature including LP flow, signup conversion, and dashboard widget functionality",
        "details": "1. Test Landing Page flow:\n   - Load LP, verify QR code displays\n   - Connect WhatsApp via QR code scan\n   - Send test message\n   - Verify message counter updates\n   - Disconnect and verify QR returns\n\n2. Test Signup conversion:\n   - After LP connection, click signup\n   - Complete Clerk auth flow\n   - Verify instance is claimed to new organization\n   - Verify redirect to dashboard\n\n3. Test Dashboard InstancesWidget:\n   - Login to dashboard\n   - Verify widget shows connected instance(s)\n   - Test carousel navigation (if multiple instances)\n   - Verify phone number displays correctly\n   - Verify device name displays\n   - Verify avatar (if available) or fallback initials\n   - Test disconnect button\n   - Verify polling updates status every 30s\n\n4. Verify rename completion:\n   - Search codebase for remaining \"demo\" references\n   - Ensure no broken imports\n   - Verify all tests pass\n\n5. Run final checks:\n   - `bun test` - all tests pass\n   - `bun build` - production build succeeds\n   - `bun typecheck` - no TypeScript errors",
        "testStrategy": "1. Create E2E test script or checklist document\n2. Manual testing on local dev environment\n3. Test on staging environment before production\n4. Document any edge cases or known issues\n5. Verify no console errors in browser\n6. Check network tab for correct API calls",
        "priority": "high",
        "dependencies": [
          "12",
          "13",
          "14",
          "15",
          "16",
          "17",
          "18",
          "19",
          "20",
          "21"
        ],
        "status": "pending",
        "subtasks": [],
        "complexity": 4,
        "recommendedSubtasks": 3,
        "expansionPrompt": "Create E2E verification checklist: (1) Test LP flow - QR display, WhatsApp connection, message sending, counter update, disconnect, (2) Test signup conversion - after LP connection, complete Clerk auth, verify instance claim, verify dashboard redirect, (3) Test dashboard InstancesWidget - verify widget shows instances, test carousel if multiple, verify data accuracy (phone, name, status, avatar), test disconnect, verify polling updates, (4) Code verification - grep for remaining 'demo' references excluding comments, run bun test, bun build, bun typecheck. Document any issues found."
      }
    ],
    "metadata": {
      "version": "1.0.0",
      "lastModified": "2025-12-07T17:47:52.930Z",
      "taskCount": 11,
      "completedCount": 8,
      "tags": [
        "master"
      ]
    }
  }
}